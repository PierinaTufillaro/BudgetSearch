{% extends "base.html" %} {% block content %}

<style>
  .card-custom {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    padding: 1.5rem;
    margin-bottom: 2rem;
  }

  .grupo-contenedor {
    position: relative;
    padding-right: 3rem;
    border-radius: 0.5rem;
    border: 1px dashed #ccc;
    margin-bottom: 1rem;
    padding: 1rem;
  }

  .btn-eliminar-grupo {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    z-index: 10;
  }

  .section-title {
    margin-top: 2.5rem;
    margin-bottom: 1.5rem;
    font-weight: bold;
    font-size: 1.5rem;
    border-bottom: 2px solid #ccc;
    padding-bottom: 0.5rem;
  }
</style>

<!-- ========================= FORMULARIO PARA CARGA NUEVA ========================= -->
{% with messages = get_flashed_messages(with_categories=true) %} {% if messages
%}
<div class="flash-container">
  {% for category, message in messages %}
  <div
    class="alert alert-{{ category }} alert-dismissible fade show"
    role="alert"
  >
    {{ message }}
    <button
      type="button"
      class="btn-close"
      data-bs-dismiss="alert"
      aria-label="Close"
    ></button>
  </div>
  {% endfor %}
</div>

<script>
  setTimeout(function () {
    const alerts = document.querySelectorAll(".alert");
    alerts.forEach((alert) => {
      alert.classList.remove("show");
      alert.classList.add("fade");
      setTimeout(() => alert.remove(), 300);
    });
  }, 3000); // Cierra en 3 segundos
</script>
{% endif %} {% endwith %}
<div class="card-custom">
  <h2 class="mb-4">ğŸ§¾ Agregar nuevo material</h2>

  <form method="post">
    <!-- MATERIAL -->
    <div class="mb-3">
      <label for="material" class="form-label">Nombre del material</label>
      <input
        type="text"
        class="form-control"
        id="material"
        name="material"
        required
      />
    </div>

    <!-- LAMINADO -->
    <div class="row mb-3">
      <div class="col-md-6">
        <label for="laminado" class="form-label">% por laminado</label>
        <input
          type="number"
          step="any"
          min="0"
          max="100"
          class="form-control"
          id="laminado"
          name="laminado"
          value="0"
        />
      </div>
    </div>
    <!-- MATERIALES MONTADOS -->
    <h5 class="mt-4">ğŸ“¦ Materiales para Montaje</h5>
    <div id="montados-container">
      <div class="grupo-contenedor montado-group">
        <button
          type="button"
          class="btn btn-sm btn-outline-danger btn-eliminar-grupo d-none"
          onclick="this.parentElement.remove()"
        >
          Eliminar
        </button>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Nombre del material de montaje</label>
            <input type="text" class="form-control" name="nombre_montado[]" />
          </div>
          <div class="col-md-6">
            <label class="form-label">% Aumento por montaje</label>
            <input
              type="number"
              step="any"
              min="0"
              class="form-control"
              name="porcentaje_por_montado[]"
              value="0"
            />
          </div>
        </div>
      </div>
    </div>

    <button
      type="button"
      class="btn btn-outline-primary mb-4"
      onclick="agregarMontado()"
    >
      + Agregar
    </button>

    <!-- PRESUPUESTOS -->
    <h5 class="mt-4">ğŸ“ Rangos de presupuesto (cmÂ²)</h5>
    <div id="presupuestos-container">
      <div class="grupo-contenedor presupuesto-group">
        <button
          type="button"
          class="btn btn-sm btn-outline-danger btn-eliminar-grupo d-none"
          onclick="this.parentElement.remove()"
        >
          Eliminar
        </button>
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Desde</label>
            <input
              type="number"
              step="any"
              min="0"
              class="form-control"
              name="medida_inicio[]"
              required
            />
          </div>
          <div class="col-md-4">
            <label class="form-label">Hasta</label>
            <input
              type="number"
              step="any"
              min="0"
              class="form-control"
              name="medida_fin[]"
              required
            />
          </div>
          <div class="col-md-4">
            <label class="form-label">Monto</label>
            <input
              type="number"
              step="any"
              min="0"
              class="form-control"
              name="monto_entre_medidas[]"
              required
              value="0"
            />
          </div>
        </div>
      </div>
    </div>
    <button
      type="button"
      class="btn btn-outline-primary mb-3"
      onclick="agregarPresupuesto()"
    >
      + Agregar
    </button>

    <!-- DESCUENTOS -->
    <h5 class="mt-4">ğŸ¯ Descuentos por cantidad</h5>
    <div id="descuentos-container">
      <div class="grupo-contenedor descuento-group">
        <button
          type="button"
          class="btn btn-sm btn-outline-danger btn-eliminar-grupo d-none"
          onclick="this.parentElement.remove()"
        >
          Eliminar
        </button>
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Cantidad desde</label>
            <input
              type="number"
              step="any"
              min="0"
              class="form-control"
              name="cantidad_inicio[]"
              required
            />
          </div>
          <div class="col-md-4">
            <label class="form-label">Cantidad hasta</label>
            <input
              type="number"
              step="any"
              min="0"
              class="form-control"
              name="cantidad_fin[]"
              required
            />
          </div>
          <div class="col-md-4">
            <label class="form-label">% Descuento</label>
            <input
              type="number"
              step="any"
              min="0"
              max="100"
              class="form-control"
              name="porcentaje_descuento[]"
              value="0"
            />
          </div>
        </div>
      </div>
    </div>
    <button
      type="button"
      class="btn btn-outline-primary mb-4"
      onclick="agregarDescuento()"
    >
      + Agregar
    </button>

    <!-- SUBMIT -->
    <div class="text-end">
      <button type="submit" class="btn btn-success">âœ… Guardar Material</button>
    </div>
  </form>
</div>

<!-- ========================= BUSCADOR ========================= -->
<form method="get" class="mb-4">
  <div class="input-group">
    <input
      type="text"
      class="form-control"
      name="busqueda"
      placeholder="Buscar material..."
      value="{{ request.args.get('busqueda', '') }}"
    />
    <button type="submit" class="btn btn-outline-primary">Buscar</button>
    <a
      href="{{ url_for('admin.admin_panel') }}"
      class="btn btn-outline-secondary"
      >Limpiar</a
    >
  </div>
</form>

<!-- ========================= VISUALIZACIÃ“N DE DATOS ========================= -->
<h2 class="section-title">ğŸ“„ Datos cargados</h2>

<!-- Rangos de presupuesto -->
<h4>ğŸ“ Rangos de Montos</h4>
<div class="table-responsive mb-4">
  <table class="table table-bordered table-striped">
    <thead>
      <tr>
        <th>Material</th>
        <th>Desde (cmÂ²)</th>
        <th>Hasta (cmÂ²)</th>
        <th>Monto por Unidad</th>
        {% if login %}
        <th>Acciones</th>
        {% endif %}
      </tr>
    </thead>
    <tbody>
      {% for p in presupuestos %}
      <tr>
        <td>{{ p.material.nombre }}</td>
        <td>{{ p.medida_inicio }}</td>
        <td>{{ p.medida_fin }}</td>
        <td>{{ p.monto_entre_medidas }}</td>
        {% if login %}
        <td>
          <a
            href="{{ url_for('admin.delete_material', material_id=p.material.id) }}"
            class="btn btn-sm btn-danger"
            onclick="return confirm('Â¿Eliminar este material por completo?');"
            >Eliminar</a
          >
          <a
            href="{{ url_for('admin.edit_material', material_id=p.material.id) }}"
            class="btn btn-sm btn-warning"
            >Editar</a
          >
        </td>
        {% endif %}
      </tr>
      {% else %}
      <tr>
        <td colspan="{% if login %}5{% else %}4{% endif %}" class="text-center">
          No hay rangos cargados.
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Montado en Material -->
<h4>ğŸ“¦ Montado en Material</h4>
<div class="table-responsive mb-4">
  <table class="table table-bordered table-striped">
    <thead>
      <tr>
        <th>Material Principal</th>
        <th>Montado en Material</th>
        <th>% Por montado</th>
      </tr>
    </thead>
    <tbody>
      {% set tiene_montados = false %} {% for material in materiales %} {% if
      material.materiales_montados %} {% for montado in
      material.materiales_montados %}
      <tr>
        <td>{{ material.nombre }}</td>
        <td>{{ montado.nombre }}</td>
        <td>{{ montado.porcentaje_por_montado }}</td>
      </tr>
      {% endfor %} {% endif %} {% endfor %} {% if not tiene_montados %}
      <tr>
        <td colspan="3" class="text-center">No hay montados.</td>
      </tr>
      {% endif %}
    </tbody>
  </table>
</div>

<!-- Descuentos -->
<h4>ğŸ’¸ Descuentos por Cantidad</h4>
<div class="table-responsive mb-4">
  <table class="table table-bordered table-striped">
    <thead>
      <tr>
        <th>Material</th>
        <th>% Laminado</th>
        <th>Desde</th>
        <th>Hasta</th>
        <th>% Descuento</th>
      </tr>
    </thead>
    <tbody>
      {% for d in descuentos %}
      <tr>
        <td>{{ d.material.nombre }}</td>
        <td>{{ d.material.porcentaje_por_laminado }}</td>
        <td>{{ d.cantidad_inicio }}</td>
        <td>{{ d.cantidad_fin }}</td>
        <td>{{ d.porcentaje_descuento_por_cantidad }}</td>
      </tr>
      {% else %}
      <tr>
        <td colspan="{% if login %}7{% else %}6{% endif %}" class="text-center">
          No hay descuentos aÃºn.
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- ========================= EDITAR CREDENCIALES ========================= -->
<div class="card-custom">
  <h2 class="mb-4">ğŸ”‘ Editar Credenciales</h2>
  <form
    method="post"
    action="{{ url_for('admin.edit_credenciales') }}"
    class="credenciales-form"
  >
    {% for cred in credenciales %}
    <div class="mb-3">
      <label for="usuario_{{ cred.id }}">Usuario</label>
      <input
        type="text"
        class="form-control"
        id="usuario_{{ cred.id }}"
        name="usuario_{{ cred.id }}"
        value="{{ cred.usuario }}"
      />
    </div>
    <div class="mb-3">
      <label for="contrasena_actual_{{ cred.id }}">ContraseÃ±a Actual</label>
      <input
        type="password"
        class="form-control"
        id="contrasena_actual_{{ cred.id }}"
        name="contrasena_actual_{{ cred.id }}"
        placeholder="Ingrese la contraseÃ±a actual"
      />
    </div>
    <div class="mb-3">
      <label for="contrasena_nueva_{{ cred.id }}">Nueva ContraseÃ±a</label>
      <input
        type="password"
        class="form-control"
        id="contrasena_nueva_{{ cred.id }}"
        name="contrasena_nueva_{{ cred.id }}"
        placeholder="Ingrese la nueva contraseÃ±a"
      />
    </div>
    <hr />
    {% endfor %}
    <div class="text-end">
      <button type="submit" class="btn btn-primary">ğŸ’¾ Guardar Cambios</button>
    </div>
  </form>
</div>

<!-- ========================= JS ========================= -->
<script>
  function agregarPresupuesto() {
    const container = document.getElementById("presupuestos-container");
    const original = document.querySelector(".presupuesto-group");
    const clone = original.cloneNode(true);

    clone.querySelectorAll("input").forEach((input) => (input.value = ""));
    clone.querySelector(".btn-eliminar-grupo").classList.remove("d-none");

    container.appendChild(clone);
  }

  function agregarDescuento() {
    const container = document.getElementById("descuentos-container");
    const original = document.querySelector(".descuento-group");
    const clone = original.cloneNode(true);

    clone.querySelectorAll("input").forEach((input) => {
      input.value = input.name.includes("porcentaje_descuento") ? "0" : "";
    });
    clone.querySelector(".btn-eliminar-grupo").classList.remove("d-none");

    container.appendChild(clone);
  }

  function agregarMontado() {
    const container = document.getElementById("montados-container");
    const original = document.querySelector(".montado-group");
    const clone = original.cloneNode(true);

    clone
      .querySelectorAll("input")
      .forEach(
        (input) => (input.value = input.name.includes("porcentaje") ? "0" : "")
      );
    clone.querySelector(".btn-eliminar-grupo").classList.remove("d-none");

    container.appendChild(clone);
  }
</script>

{% endblock %}
