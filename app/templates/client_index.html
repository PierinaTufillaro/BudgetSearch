{% extends "base.html" %}
{% block content %}

<style>
  .card-custom {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    padding: 1.5rem;
    margin-bottom: 2rem;
  }
</style>

<div class="card-custom">
  <h2 class="mb-4">Calcular Presupuesto</h2>

  <form method="post" action="{{ url_for("client.client_index") }}">
    <div class="row g-3 mb-3">
      <div class="col-md-6">
        <label for="ancho" class="form-label">Ancho (cm)</label>
        <input type="number" step="any" min="0" class="form-control" id="ancho" name="ancho" required value="{{ request.form.ancho }}">
      </div>
      <div class="col-md-6">
        <label for="alto" class="form-label">Alto (cm)</label>
        <input type="number" step="any" min="0" class="form-control" id="alto" name="alto" required value="{{ request.form.alto }}">
      </div>
    </div>

    <div class="mb-3">
      <label for="material" class="form-label">Material</label>
      <select class="form-select" id="material" name="material" required>
        <option value="" disabled {% if not request.form.material %}selected{% endif %}>Seleccione un Material</option>
        {% for mat in materiales %}
          <option value="{{ mat.id }}" {% if request.form.material == mat.id|string %}selected{% endif %}>
            {{ mat.nombre }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="mb-3" id="montaje-div" style="display:none;">
      <label for="material_montado" class="form-label">Montaje</label>
      <select class="form-select" id="material_montado" name="material_montado">
        <option value="" selected disabled>Seleccione un tipo de montaje</option>
      </select>
    </div>
    
  
    <div class="mb-3">
      <label for="cantidad" class="form-label">Cantidad</label>
      <input type="number" step="1" min="1" class="form-control" id="cantidad" name="cantidad" required value="{{ request.form.cantidad }}">
    </div>

    <div class="form-check mb-4">
      <input class="form-check-input" type="checkbox" id="laminado" name="laminado" {% if request.form.laminado %}checked{% endif %}>
      <label class="form-check-label" for="laminado">
        Incluir laminado
      </label>
    </div>

    <button type="submit" class="btn btn-success">Calcular Presupuesto</button>
  </form>

  {% if resultado %}
    {% if resultado.error %}
      <div class="alert alert-danger mt-4">{{ resultado.error }}</div>
    {% else %}
      <div class="alert alert-success mt-4">
        <p><strong>Material:</strong> {{ resultado.material }}</p>
        <p><strong>Área:</strong> {{ resultado.area }} cm²</p>
        <p><strong>Laminado:</strong> {{ 'Sí' if resultado.laminado else 'No' }}</p>
        <p><strong>Descuento por cantidad aplicado:</strong> {{ resultado.descuento_cantidad }} %</p>
        {% if resultado.material_montado %}
          <p><strong>Precio adicional por montaje ({{ resultado.material_montado }}):</strong> ${{ resultado.precio_montado }}</p>
        {% endif %}
        <p><strong>Precio unitario (por pieza):</strong> ${{ resultado.precio_unitario }}</p>
        <p><strong>Precio total:</strong> ${{ resultado.precio_total }}</p>
      </div>
    {% endif %}
{% endif %}

</div>

<script>
  const montajesPorMaterial = {{ materiales_montados | tojson }};
  const materialSelect = document.getElementById("material");
  const montajeDiv = document.getElementById("montaje-div");
  const montajeSelect = document.getElementById("material_montado");

  function actualizarMontajes() {
    const materialId = materialSelect.value;
    const montajes = montajesPorMaterial[materialId] || [];

    montajeSelect.options.length = 1; // solo opción default

    if (montajes.length > 0) {
      montajes.forEach(m => {
        const option = document.createElement("option");
        option.value = m.id;
        option.textContent = `${m.nombre} (${m.porcentaje} %)`;
        montajeSelect.appendChild(option);
      });
      montajeDiv.style.display = "block";
    } else {
      montajeDiv.style.display = "none";
    }
  }

  materialSelect.addEventListener("change", actualizarMontajes);

  window.addEventListener("DOMContentLoaded", () => {
    if (materialSelect.value) {
      actualizarMontajes();

      setTimeout(() => {
        const seleccionado = "{{ request.form.material_montado | default('') }}";
        if (seleccionado) {
          montajeSelect.value = seleccionado;
        }
      }, 0);
    }
  });
</script>

{% endblock %}



